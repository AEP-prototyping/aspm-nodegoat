name: security operations
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    name: NodeGoat Security Pipeline
    steps:
      - uses: actions/checkout@v3
      - name: Installing node
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm install
      - name: Black Duck Scan
        shell: bash
        env:
          BRIDGE_DOWNLOAD: ${{ secrets.BRIDGECLI_LINUX64 }}        
          BRIDGE_BLACKDUCK_URL: ${{ secrets.BRIDGE_BLACKDUCK_URL }}
          BRIDGE_BLACKDUCK_TOKEN: ${{ secrets.BRIDGE_BLACKDUCK_TOKEN }}
          BRIDGE_POLARIS_URL: ${{ secrets.BRIDGE_POLARIS_URL }}
          BRIDGE_POLARIS_ACCESSTOKEN: ${{ secrets.BRIDGE_POLARIS_ACCESSTOKEN }}
          BRIDGE_GITHUB_USER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRIDGE_GITHUB_REPOSITORY_OWNER_NAME: ${{ github.repository_owner }}
          BRIDGE_GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          BRIDGE_GITHUB_REPOSITORY_BRANCH_NAME: ${{ github.ref_name }}
        run: |
          curl -fLsS -o bridge.zip $BRIDGE_DOWNLOAD && unzip -qo -d ${{ runner.temp }} bridge.zip && rm -f bridge.zip
          ${{ runner.temp }}/synopsys-bridge --stage blackduck \
            blackduck.scan.full='true' \
            blackduck.scan.failure.severities='BLOCKER' \
            blackduck.fixpr.enabled='false' \
            blackduck.reports.sarif.create='false'
      - name: Polaris Scan
        shell: bash
        run: |
          export BRIDGE_POLARIS_ACCESSTOKEN=$BRIDGE_POLARIS_ACCESSTOKEN
          ${{ runner.temp }}/synopsys-bridge --stage polaris polaris.project.name="NodeGoat" \
          polaris.branch.name=$BRIDGE_GITHUB_REPOSITORY_BRANCH_NAME \
          polaris.application.name="JP-NodeGoat" \
          polaris.assessment.types=SAST \
          polaris.serverurl=$BRIDGE_POLARIS_URL \
